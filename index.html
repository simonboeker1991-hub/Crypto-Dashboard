<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crypto-Dashboard ¬∑ FED ¬∑ BTC ¬∑ KAS ¬∑ Risiko-Ampel</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --muted:#64748b; --text:#0f172a;
      --emerald:#10b981; --amber:#f59e0b; --red:#ef4444; --blue:#0ea5e9;
      --btc:#10b981; --kas:#f59e0b; --border:#e2e8f0; --ring:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(to bottom,#f8fafc,#fff);color:var(--text)}
    .container{max-width:1120px;margin:0 auto;padding:16px}
    h1{font-size:1.375rem;margin:0 0 4px 0}
    .sub{color:var(--muted);font-size:.875rem}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:768px){.row-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card .hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card h2{font-size:1rem;margin:0;display:flex;align-items:center;gap:8px}
    .card .cnt{padding:12px 16px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:3px 8px;font-size:12px;font-weight:600}
    .pill.neutral{background:#d1fae5;color:#065f46}
    .pill.elevated{background:#fffbeb;color:#92400e}
    .pill.overheated{background:#fee2e2;color:#991b1b}
    .tldr-stance.neutral{color:#475569}.tldr-stance.bullish{color:#059669}.tldr-stance.bearish{color:#dc2626}
    .kv{font-size:.95rem;margin:4px 0}
    .muted{color:var(--muted)}
    .price{font-size:1.4rem;font-weight:700}
    .grid4{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1024px){.grid4{grid-template-columns:repeat(4,1fr)}}
    .status-card{border:1px solid var(--border);border-radius:12px;padding:10px}
    .riskbar{height:8px;width:100%;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .riskbar>div{height:100%}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .controls{display:grid;gap:10px}
    input[type="text"],input[type="password"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);outline:none}
    input:focus,textarea:focus{border-color:var(--ring)}
    ul.cal{list-style:none;margin:0;padding:0}
    ul.cal li{margin:8px 0}
    details{background:#fafafa;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    details summary{cursor:pointer;list-style:none}
    details summary::-webkit-details-marker{display:none}
    .sources{margin-top:8px;color:var(--muted);font-size:12px}
    .flex{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .small{font-size:12px}
    .hidden{display:none}
    .footer{margin:18px 0;color:var(--muted);font-size:12px}
    .link-small{font-size:12px;color:#0ea5e9;text-decoration:none}
    .link-small:hover{text-decoration:underline}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px}
    .badge.up{background:#ecfdf5;color:#065f46}
    .badge.down{background:#fee2e2;color:#991b1b}
    .range{margin-top:8px}
    .range-head{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:#64748b}
    .rangebar{position:relative;height:10px;background:#e5e7eb;border-radius:999px;margin-top:4px}
    .rangemark{position:absolute;top:-3px;width:2px;height:16px;background:#0ea5e9}
    .rangemark.btc{background:var(--btc)}
    .rangemark.kas{background:var(--kas)}
    .spark{width:100%;height:90px;display:block;margin-top:8px}
    .tabs{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .tab{appearance:none;border:0;margin:0;padding:6px 10px;background:#fff;color:#334155;cursor:pointer;font-size:12px}
    .tab+ .tab{border-left:1px solid var(--border)}
    .tab.active{background:#0ea5e9;color:#fff}
    ul.news{list-style:none;margin:0;padding:0}
    .news li{border:1px solid var(--border);border-radius:12px;padding:10px;margin:10px 0;background:#fafafa}
    .news .title{font-weight:600}
    .news .meta{color:var(--muted);font-size:12px;margin-top:2px}
    .news .summary{font-size:13px;margin-top:6px;color:#334155}
  </style>
</head>
<body>
  <div class="container">
    <div class="flex">
      <div>
        <h1>Crypto-Dashboard <span class="muted">¬∑ FED ¬∑ BTC ¬∑ KAS ¬∑ Risiko-Ampel</span></h1>
        <div class="sub" id="last-upd">Letzter Abruf: ‚Äì</div>
      </div>
      <div class="right">
        <button class="btn" id="btn-refresh">Aktualisieren</button>
        <button class="btn" id="btn-demo">Demo laden</button>
        <button class="btn" id="btn-settings" style="display:none">Einstellungen</button>
      </div>
    </div>

    <!-- TL;DR -->
    <div class="card" style="margin-top:12px;">
      <div class="hdr"><h2>TL;DR <span class="tldr-stance neutral" id="stance"></span></h2></div>
      <div class="cnt">
        <div class="small muted">Bedeutung: ‚ÄûToo Long; Didn‚Äôt Read‚Äú ‚Äì ein einzeiliges Kurzfazit (Bullish/Neutral/Bearish) mit 1‚Äì2 Hauptgr√ºnden.</div>
        <div id="headline" class="kv"></div>
      </div>
    </div>

    <!-- Grid -->
    <div class="row row-3" style="margin-top:16px;">
      <!-- Macro -->
      <div class="card">
        <div class="hdr"><h2>FED / Makro</h2></div>
        <div class="cnt">
          <div class="kv">üßÆ <b>CPI YoY:</b> <span id="cpi"></span> <span class="muted" id="cpimonth"></span></div>
          <div class="kv">üèõÔ∏è <b>FOMC:</b> <span id="fomc"></span></div>
          <div class="kv">üßæ <b>PCE:</b> <span id="pce"></span></div>
          <div class="kv" id="fedwatch"></div>
          <div class="sources" id="macro-sources"></div>
        </div>
      </div>

      <!-- BTC -->
      <div class="card">
        <div class="hdr">
          <h2>Bitcoin (BTC)</h2>
          <div class="tabs" data-asset="btc">
            <button class="tab active" data-tf="24h">24h</button>
            <button class="tab" data-tf="7d">7T</button>
            <button class="tab" data-tf="1m">1M</button>
            <button class="tab" data-tf="1y">1J</button>
          </div>
        </div>
        <div class="cnt">
          <div class="price" id="btc-price">$‚Äì</div>
          <div class="badges" id="btc-badges"></div>

          <div class="range" id="btc-range">
            <div class="range-head">
              <span id="btc-range-low">Low: ‚Äì</span>
              <span>30-Tage-Spanne</span>
              <span id="btc-range-high">High: ‚Äì</span>
            </div>
            <div class="rangebar">
              <div class="rangemark btc" id="btc-range-mark" style="left:0%"></div>
            </div>
          </div>

          <div class="small muted" id="btc-etf"></div>

          <details style="margin-top:8px;">
            <summary class="small">Minichart (optional)</summary>
            <canvas class="spark" id="btc-chart"></canvas>
          </details>

          <div class="sources" id="btc-sources"></div>
        </div>
      </div>

      <!-- KAS -->
      <div class="card">
        <div class="hdr">
          <h2>Kaspa (KAS)</h2>
          <div class="tabs" data-asset="kas">
            <button class="tab active" data-tf="24h">24h</button>
            <button class="tab" data-tf="7d">7T</button>
            <button class="tab" data-tf="1m">1M</button>
            <button class="tab" data-tf="1y">1J</button>
          </div>
        </div>
        <div class="cnt">
          <div class="price" id="kas-price">$‚Äì</div>
          <div class="badges" id="kas-badges"></div>

          <div class="range" id="kas-range">
            <div class="range-head">
              <span id="kas-range-low">Low: ‚Äì</span>
              <span>30-Tage-Spanne</span>
              <span id="kas-range-high">High: ‚Äì</span>
            </div>
            <div class="rangebar">
              <div class="rangemark kas" id="kas-range-mark" style="left:0%"></div>
            </div>
          </div>

          <details style="margin-top:8px;">
            <summary class="small">Minichart (optional)</summary>
            <canvas class="spark" id="kas-chart"></canvas>
          </details>

          <div class="sources" id="kas-sources"></div>
        </div>
      </div>

      <!-- Peak-Watch -->
      <div class="card" style="grid-column:1/-1;">
        <div class="hdr">
          <h2>Peak-Watch (BTC)</h2>
          <a class="link-small" href="https://www.coinglass.com/bull-market-peak-signals" target="_blank" rel="noopener">CoinGlass Peak Signals ‚Üó</a>
        </div>
        <div class="cnt">
          <div class="grid4" id="peak-grid"></div>
          <div class="sources" id="peak-sources"></div>
        </div>
      </div>

      <!-- Risiko-Ampel -->
      <div class="card">
        <div class="hdr"><h2>Risiko-Ampel</h2></div>
        <div class="cnt">
          <div class="flex"><div id="risk-label" class="kv"></div><div class="kv" id="risk-score"></div></div>
          <div class="riskbar"><div id="riskbar-fill" style="width:0%;background:#10b981;"></div></div>
          <div class="small muted" style="margin-top:8px;">Heuristik: ‚úÖ=0, ‚ö†Ô∏è=1, üî•=2 ¬∑ Gewichte: MVRV 1.5, Puell 1.0, RHODL 1.2, SOPR 0.8, Funding 0.8, OI 1.0, Miner 0.7, Trends 0.6.</div>
        </div>
      </div>

      <!-- Kalender -->
      <div class="card">
        <div class="hdr"><h2>Kalender</h2></div>
        <div class="cnt">
          <ul class="cal" id="cal-list"></ul>
          <div class="small muted">Tipp: Klick auf einen Termin f√ºr Details/Links.</div>
          <div class="sources" id="cal-sources"></div>
        </div>
      </div>

      <!-- Newsfeed -->
      <div class="card" style="grid-column:1/-1;">
        <div class="hdr"><h2>News <span class="small muted" id="news-mode"></span></h2></div>
        <div class="cnt">
          <ul class="news" id="news-list"><li class="small muted">Lade News‚Ä¶</li></ul>
          <div class="sources" id="news-sources"></div>
        </div>
      </div>
    </div>

    <!-- Einstellungen (Admin) -->
    <div id="settings" class="card hidden" style="margin-top:16px;">
      <div class="hdr"><h2>Einstellungen</h2></div>
      <div class="cnt">
        <div class="controls">
          <label>Endpoint-URL (liefert DashboardData JSON)</label>
          <input type="text" id="endpoint" placeholder="https://simonboeker1991-hub.github.io/Crypto-Dashboard/data.json">
          <div class="flex">
            <button class="btn primary" id="btn-fetch">Fetch</button>
            <button class="btn" id="btn-save">URL speichern</button>
          </div>

          <label>CryptoPanic API Token (optional f√ºr Live-News ‚Äì bleibt lokal)</label>
          <input type="password" id="cp-token" placeholder="xxxxxxxxxxxxxxxxxxxx">
          <div class="flex">
            <button class="btn" id="btn-save-cp">Token speichern</button>
            <button class="btn" id="btn-live-news">Live-News laden</button>
          </div>

          <div class="flex" style="margin-top:8px;">
            <button class="btn" id="btn-hard-reload">Cache leeren & hart neu laden</button>
          </div>

          <label>Manuelle Daten (JSON)</label>
          <textarea rows="8" id="manualjson" placeholder='{"generated_at":"...","tldr":{"headline":"...","stance":"Neutral"}, ...}'></textarea>
          <div class="flex">
            <button class="btn" id="btn-apply">Anwenden</button>
            <button class="btn" id="btn-filldemo">Demo einf√ºgen</button>
          </div>
          <div class="small muted">Admin-Modus: Button erscheint nur mit <b>?setup=1</b> (oder <b>#settings</b>). Mit <b>?noadmin=1</b> wieder aus.</div>
        </div>
      </div>
    </div>

    <div class="footer">¬© 2025 ¬∑ Single-file Dashboard (PWA-f√§hig). Zum Installieren hosten (GitHub Pages) und dann <b>Zum Startbildschirm hinzuf√ºgen</b>.</div>
  </div>

  <script>
    /* ---------- Demo-Daten (kurz) ---------- */
    const DEMO = {
      "generated_at": new Date().toISOString(),
      "tldr":{"headline":"Neutral ‚Üí leicht risk-on: M√§rkte preisen Sept-Senkung ein; ETF-Zufl√ºsse positiv.","stance":"Neutral"},
      "macro":{"cpi_yoy":2.7,"cpi_month":"Juli 2025","pce_date":"2025-08-29","fomc_next":"16.‚Äì17.09.2025","fedwatch_comment":"Futures implizieren hohe Chance auf ‚àí25 bp im September.","sources":["BLS","CME FedWatch","Federal Reserve"]},
      "btc":{"price":117651,"spark":{"24h":[118900,118520,118360,118050,117900,117780,117720,117651],"7d":[119500,118700,118300,118800,117900,117700,117651],"1m":[116000,119000,118200,117800,118400,117651],"1y":[43000,52000,61000,70000,76000,68000,75000,82000,77000,90000,98000,117651]},"etf":{"yesterday":114000000,"yesterday_date":"2025-08-15","sum5d":638000000,"source":"Farside"}},
      "kas":{"price":0.0902,"spark":{"24h":[0.0915,0.0912,0.0910,0.0908,0.0906,0.0904,0.0903,0.0902],"7d":[0.093,0.0923,0.0918,0.0912,0.0909,0.0906,0.0902],"1m":[0.088,0.091,0.0895,0.0900,0.0907,0.0902],"1y":[0.036,0.045,0.055,0.062,0.070,0.065,0.078,0.082,0.089,0.094,0.092,0.0902]}},
      "peak":{"mvrv":{"status":"elevated"},"puell":{"status":"neutral"},"rhodl":{"status":"elevated"},"sopr":{"status":"elevated"},"funding":{"status":"elevated"},"oi":{"status":"elevated"},"miner":{"status":"neutral"},"trends":{"status":"neutral"},"sources":["LookIntoBitcoin","Coinglass","Google Trends"]},
      "calendar":{"items":[
        {"date":"21.‚Äì23.08.2025","title":"Jackson Hole Symposium","impact":"high","desc":"Notenbanker & Fed ‚Äì Hinweise zur Geldpolitik.","source":"Kansas City Fed","link":"https://www.kansascityfed.org/research/jackson-hole-economic-policy-symposium/"},
        {"date":"2025-08-29","title":"US PCE (Juli)","impact":"high","desc":"Bevorzugtes Inflationsma√ü der Fed.","source":"BEA","link":"https://www.bea.gov/"},
        {"date":"2025-09-11","title":"US CPI (August)","impact":"high","desc":"Kern- und Gesamtinflation.","source":"BLS","link":"https://www.bls.gov/"}
      ],"sources":["BLS","BEA","Federal Reserve"]},
      "news":{"items":[{"title":"BTC h√§lt wichtige Unterst√ºtzung ‚Äì Derivate signalisieren Risikoappetit","source":"The Block","time":"2025-08-16T09:20:00Z","tickers":["BTC"],"summary":"Funding leicht positiv; OI √ºber 30T-√ò.","url":"https://example.com"}], "sources":["CME","The Block"]}
    };

    /* ---------- Helpers ---------- */
    const TF_STATE={btc:'24h', kas:'24h'};
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    const toNum = (x)=> (x==null || x==='') ? null : Number(x);
    function parseAnyDate(x){ if(x==null) return null; if(typeof x==='number'){const d=new Date(x);return isNaN(d)?null:d;} const s=String(x).trim(); let d=new Date(s); if(!isNaN(d)) return d; if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(s)){d=new Date(s.replace(' ','T')); if(!isNaN(d)) return d;} const m=s.match(/^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2}))?/); if(m){const[_,dd,mm,yy,hh='00',mi='00']=m; d=new Date(`${yy}-${mm}-${dd}T${hh}:${mi}:00`); if(!isNaN(d)) return d;} return null; }
    function series(asset,tf){const a=LAST?.[asset]; if(!a) return null; const arr=(a.spark||{})[tf]||(a.spark||{})[tf.toLowerCase()]; return Array.isArray(arr)?arr.map(v=>({v:Number(v)})):null;}
    function pctFrom(arr){ if(!arr||arr.length<2) return null; const a=Number(arr[0]), b=Number(arr[arr.length-1]); if(!isFinite(a)||a===0) return null; return (b/a-1)*100; }
    function minmax(arr){ if(!arr||!arr.length) return null; let mn=+Infinity,mx=-Infinity; for(const v of arr){ const n=Number(v); if(n<mn) mn=n; if(n>mx) mx=n; } return {min:mn,max:mx}; }
    function drawSpark(id, points, color){ const cv=document.getElementById(id); if(!cv) return; if(!points||points.length<2){cv.classList.add('hidden');return} cv.classList.remove('hidden'); const dpr=window.devicePixelRatio||1; const W=(cv.clientWidth||320), H=90; cv.width=Math.floor(W*dpr); cv.height=Math.floor(H*dpr); cv.style.width=W+'px'; cv.style.height=H+'px'; const ctx=cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H); const vals=points.map(p=>+p.v); const min=Math.min(...vals), max=Math.max(...vals); const pad=6, n=vals.length, step=W/Math.max(1,(n-1)); ctx.lineWidth=2; ctx.strokeStyle=color||'#0ea5e9'; ctx.beginPath(); for(let i=0;i<n;i++){ const x=i*step; const y=H-((vals[i]-min)/(max-min||1))*(H-pad*2)-pad; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); }

    /* ---------- Risiko ---------- */
    const weights={mvrv:1.5,puell:1.0,rhodl:1.2,sopr:0.8,funding:0.8,oi:1.0,miner:0.7,trends:0.6};
    const scoreFor=s=>s==='overheated'?2:(s==='elevated'?1:0);
    function riskScore(p){if(!p)return{total:0,light:'green'};const t=scoreFor(p.mvrv?.status)*weights.mvrv+scoreFor(p.puell?.status)*weights.puell+scoreFor(p.rhodl?.status)*weights.rhodl+scoreFor(p.sopr?.status)*weights.sopr+scoreFor(p.funding?.status)*weights.funding+scoreFor(p.oi?.status)*weights.oi+scoreFor(p.miner?.status)*weights.miner+scoreFor(p.trends?.status)*weights.trends;return{total:Number(t.toFixed(1)),light:t<3?'green':(t<=6?'yellow':'red')}}

    /* ---------- Live-News (optional) ---------- */
    function getCpToken(){ try{return localStorage.getItem('cryptoDash.cpToken')||'';}catch(_){return ''}}
    function saveCpToken(v){ try{localStorage.setItem('cryptoDash.cpToken',v||'');}catch(_){} }
    async function fetchCryptoPanic(){
      const token=getCpToken(); if(!token) throw new Error('Kein Token');
      const url=`https://cryptopanic.com/api/v1/posts/?auth_token=${encodeURIComponent(token)}&currencies=BTC,KAS&kind=news&public=true&regions=en,de&filter=rising&page=1`;
      const resp=await fetch(url,{cache:'no-store'}); if(!resp.ok) throw new Error('HTTP '+resp.status);
      const j=await resp.json();
      const items=(j.results||[]).map(it=>({title:it.title, source:it.source?.title||it.domain||'CryptoPanic', time:it.published_at, tickers:(it.currencies||[]).map(c=>c.code), summary:it.metadata?.description||'', url:it.url}));
      return {items, sources:['CryptoPanic']};
    }
    function renderNewsBlock(block, label){
      const nl=document.getElementById('news-list'); const mode=document.getElementById('news-mode'); const src=document.getElementById('news-sources');
      mode.textContent = label?`(${label})`:'';
      if(!block||!block.items||block.items.length===0){ nl.innerHTML='<li class="small muted">Keine aktuellen News.</li>'; src.textContent=''; return; }
      nl.innerHTML=block.items.slice(0,20).map(n=>{ const t=parseAnyDate(n.time); const when=t?t.toLocaleString():''; const tick=(n.tickers||[]).map(x=>`<span class="badge">${x}</span>`).join(' '); const sum=(n.summary||'').toString(); const short=sum.length>240?sum.slice(0,240)+'‚Ä¶':sum; return `<li><div class="title"><a class="link-small" href="${n.url||'#'}" target="_blank" rel="noopener">${n.title||'-'}</a></div><div class="meta">${n.source?n.source:''}${when?` ¬∑ ${when}`:''} ${tick?` ¬∑ ${tick}`:''}</div>${short?`<div class="summary">${short}</div>`:''}</li>`; }).join('');
      src.textContent=block.sources&&block.sources.length?('Quellen: '+block.sources.join(', ')):'';
    }

    let LAST=null, LIVE_NEWS_TIMER=null;

    /* ---------- Render ---------- */
    function render(data){
      LAST=data;

      // Zeitstempel: Abrufzeit (gro√ü) + Datenzeit (Quelle)
      const srcTs = parseAnyDate(data.generated_at);
      const fetchTs = parseAnyDate(data._fetched_at) || new Date();
      document.getElementById('last-upd').innerHTML =
        `Letzter Abruf: ${fetchTs.toLocaleString()} ` +
        `<span class="muted">¬∑ Quelle: ${srcTs ? srcTs.toLocaleString() : '‚Äì'}</span>`;

      // TL;DR
      const stance=(data.tldr?.stance||'Neutral').toLowerCase();
      const stanceEl=document.getElementById('stance');
      stanceEl.className='tldr-stance '+(stance==='bullish'?'bullish':(stance==='bearish'?'bearish':'neutral'));
      stanceEl.textContent=data.tldr?.stance||'Neutral';
      document.getElementById('headline').textContent=data.tldr?.headline||'';

      // Macro
      document.getElementById('cpi').textContent=(toNum(data.macro?.cpi_yoy)!=null)?(Number(data.macro.cpi_yoy).toFixed(1)+' %'):'‚Äì';
      document.getElementById('cpimonth').textContent=data.macro?.cpi_month?`(${data.macro.cpi_month})`:'';
      document.getElementById('fomc').textContent=data.macro?.fomc_next||'‚Äì';
      document.getElementById('pce').textContent=data.macro?.pce_date||'‚Äì';
      document.getElementById('fedwatch').textContent=data.macro?.fedwatch_comment||'';
      document.getElementById('macro-sources').textContent=(data.macro?.sources||[]).length?'Quellen: '+data.macro.sources.join(', '):'';

      // BTC
      const btcP=toNum(data.btc?.price);
      document.getElementById('btc-price').textContent=btcP!=null?'$'+Number(btcP).toLocaleString():'$‚Äì';
      renderBadges('btc'); renderRange('btc', btcP||0);
      const etfNode=document.getElementById('btc-etf');
      if(data.btc?.etf?.yesterday && data.btc?.etf?.sum5d){
        const d=parseAnyDate(data.btc.etf.yesterday_date); const dStr=d?new Date(d).toLocaleDateString():'gestern';
        const m=(n)=> (n>=0?'+':'') + (Number(n)/1e6).toFixed(0) + ' Mio';
        etfNode.textContent=`Spot-ETF-Zufl√ºsse: ${m(data.btc.etf.yesterday)} (${dStr}); 5-Tage-Summe: ${m(data.btc.etf.sum5d)} ¬∑ Quelle: ${data.btc.etf.source||'-'}`;
      } else { etfNode.textContent=data.btc?.etf_flows_comment||''; }
      document.getElementById('btc-sources').textContent=(data.btc?.sources||[]).length?'Quellen: '+data.btc.sources.join(', '):'';
      drawSpark('btc-chart', series('btc', TF_STATE.btc), getComputedStyle(document.documentElement).getPropertyValue('--btc').trim());

      // KAS
      const kasP=toNum(data.kas?.price);
      document.getElementById('kas-price').textContent=kasP!=null?'$'+Number(kasP).toFixed(4):'$‚Äì';
      renderBadges('kas'); renderRange('kas', +kasP||0);
      document.getElementById('kas-sources').textContent=(data.kas?.sources||[]).length?'Quellen: '+data.kas.sources.join(', '):'';
      drawSpark('kas-chart', series('kas', TF_STATE.kas), getComputedStyle(document.documentElement).getPropertyValue('--kas').trim());

      // Peak-Watch
      const grid=document.getElementById('peak-grid');
      if(grid){
        const map=[['mvrv','MVRV Z-Score'],['puell','Puell Multiple'],['rhodl','RHODL Ratio'],['sopr','SOPR'],['funding','Funding-Rate'],['oi','Open Interest'],['miner','Miner-Flows'],['trends','Google Trends']];
        grid.innerHTML=map.map(([k,label])=>{
          const it=data.peak?.[k]||{status:'neutral'};
          const cls=it.status==='neutral'?'pill neutral':(it.status==='elevated'?'pill elevated':'pill overheated');
          const lbl=it.status==='neutral'?'Neutral':(it.status==='elevated'?'Erh√∂ht':'√úberhitzt');
          return `<div class="status-card"><div class="flex"><div class="kv" style="font-weight:600;">${label}</div><span class="${cls}">${lbl}</span></div>${it.note?`<div class="small muted" style="margin-top:6px;">${it.note}</div>`:''}</div>`;
        }).join('');
      }
      document.getElementById('peak-sources').textContent=(data.peak?.sources||[]).length?'Quellen: '+data.peak.sources.join(', '):'';

      // Risiko-Ampel
      const r=riskScore(data.peak||{});
      document.getElementById('risk-score').textContent='Score: '+r.total;
      document.getElementById('risk-label').textContent=r.light==='green'?'üü¢ Niedrig':(r.light==='yellow'?'üü° Moderat':'üî¥ Hoch');
      const fill=document.getElementById('riskbar-fill'); let pct=0;
      if(r.light==='green') pct=clamp((r.total/6)*100,0,100); else if(r.light==='yellow') pct=clamp(((r.total-3)/3)*100,0,100); else pct=clamp(((r.total-6)/3)*100,0,100);
      fill.style.width=pct+'%'; fill.style.background=r.light==='green'?'#10b981':(r.light==='yellow'?'#f59e0b':'#ef4444');

      // Kalender
      const ul=document.getElementById('cal-list');
      if(ul){
        ul.innerHTML=(data.calendar?.items||[]).map(it=>{
          const impact=(it.impact||'low').toLowerCase();
          const lbl=impact.startsWith('high')?'Hoch':(impact.startsWith('med')?'Mittel':'Niedrig');
          const cls=impact.startsWith('high')?'overheated':impact.startsWith('med')?'elevated':'neutral';
          const pill=`<span class="pill ${cls}">${lbl}</span>`;
          const summary=`<b>${it.date}</b> ‚Äî ${it.title} ${pill}`;
          const body=(it.desc||it.link||it.source)
            ? `<div class="small" style="margin-top:6px;">${it.desc?it.desc:''} ${it.link?`<a class="link-small" href="${it.link}" target="_blank" rel="noopener">Mehr ‚Üó</a>`:''} ${it.source?`<span class="muted">(${it.source})</span>`:''}</div>`
            : '';
          return `<li><details><summary>${summary}</summary>${body}</details></li>`;
        }).join('');
      }
      document.getElementById('cal-sources').textContent=(data.calendar?.sources||[]).length?'Quellen: '+data.calendar.sources.join(', '):'';

      // News (live falls Token, sonst data.json)
      if(getCpToken()){
        fetchCryptoPanic().then(b=>renderNewsBlock(b,'live')).catch(()=>{ if(data.news) renderNewsBlock(data.news,'data.json'); else renderNewsBlock({items:[]},'');});
        if(LIVE_NEWS_TIMER) clearInterval(LIVE_NEWS_TIMER);
        LIVE_NEWS_TIMER=setInterval(()=>fetchCryptoPanic().then(b=>renderNewsBlock(b,'live')),15*60*1000);
      } else if(data.news){ renderNewsBlock(data.news,'data.json'); } else { renderNewsBlock({items:[]},''); }
    }

    /* ---------- Badges & Range ---------- */
    function renderBadges(asset){
      const el=document.getElementById(asset+'-badges'); if(!el) return;
      const frames=[['24h','24h'],['7d','7T'],['1m','1M'],['1y','1J']];
      el.innerHTML=frames.map(([tf,label])=>{
        const s=series(asset,tf); const arr=s?s.map(p=>p.v):null; const pct=pctFrom(arr||[]);
        if(pct==null) return `<span class="badge">${label} ‚Äì</span>`;
        const cls=pct>=0?'up':'down'; const sign=pct>=0?'+':'';
        return `<span class="badge ${cls}">${label} ${sign}${pct.toFixed(2)}%</span>`;
      }).join('');
    }
    function renderRange(asset, current){
      const pref=series(asset,'1m')?.map(p=>p.v) || series(asset,'7d')?.map(p=>p.v);
      const box=document.getElementById(asset+'-range'); if(!box) return;
      const lowEl=document.getElementById(asset+'-range-low');
      const highEl=document.getElementById(asset+'-range-high');
      const mark=document.getElementById(asset+'-range-mark');
      if(!pref||pref.length<2){ box.classList.add('hidden'); return; }
      const mm=minmax(pref); if(!mm){ box.classList.add('hidden'); return; }
      box.classList.remove('hidden');
      lowEl.textContent='Low: '+(asset==='kas'?'$'+mm.min.toFixed(4):'$'+Math.round(mm.min).toLocaleString());
      highEl.textContent='High: '+(asset==='kas'?'$'+mm.max.toFixed(4):'$'+Math.round(mm.max).toLocaleString());
      const pct=clamp(((current-mm.min)/Math.max(1e-9,mm.max-mm.min))*100,0,100);
      mark.style.left=pct+'%';
    }

    /* ---------- Fetch & Refresh ---------- */
    async function doFetch(url){
      try{
        const bust=(url.includes('?')?'&':'?')+'v='+Date.now();
        const resp=await fetch(url+bust,{headers:{'accept':'application/json'},cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const j=await resp.json();
        j._fetched_at = new Date().toISOString();   // <‚Äî Abrufzeit f√ºr Anzeige
        render(j);
      }catch(e){ console.warn('Fetch-Fehler:',e); }
    }
    function refreshNow(force=false){
      if(force){
        if('caches' in window){ caches.keys().then(keys=>keys.filter(k=>k.startsWith('crypto-dash-')).forEach(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.update())); }
      }
      const saved=localStorage.getItem('cryptoDash.endpoint');
      if(saved) doFetch(saved); else {
        const d = JSON.parse(JSON.stringify(DEMO));
        d._fetched_at = new Date().toISOString();
        render(d);
      }
    }

    /* ---------- UI / Admin ---------- */
    const settings=document.getElementById('settings');
    document.getElementById('btn-demo').onclick=()=>{
      const d = JSON.parse(JSON.stringify(DEMO));
      d._fetched_at = new Date().toISOString();   // <‚Äî Abrufzeit auch f√ºr Demo
      render(d);
    };
    document.getElementById('btn-refresh').onclick=()=>refreshNow(false);

    const ep=document.getElementById('endpoint');
    try{const saved=localStorage.getItem('cryptoDash.endpoint'); if(saved) ep.value=saved;}catch(_){}
    document.getElementById('btn-save')?.addEventListener('click',()=>{localStorage.setItem('cryptoDash.endpoint',ep.value||''); alert('Gespeichert.');});
    document.getElementById('btn-fetch')?.addEventListener('click',()=>{ if(!ep.value) return alert('Bitte Endpoint-URL eintragen.'); localStorage.setItem('cryptoDash.endpoint',ep.value); doFetch(ep.value); });
    document.getElementById('btn-settings').onclick=()=>settings.classList.toggle('hidden');
    document.getElementById('btn-filldemo')?.addEventListener('click',()=>{document.getElementById('manualjson').value=JSON.stringify(DEMO,null,2);});
    document.getElementById('btn-apply')?.addEventListener('click',()=>{const raw=document.getElementById('manualjson').value; try{render(JSON.parse(raw));}catch(e){alert('Ung√ºltiges JSON: '+e);}});
    document.getElementById('btn-hard-reload')?.addEventListener('click',()=>{ refreshNow(true); setTimeout(()=>location.reload(),300); });

    const cp=document.getElementById('cp-token');
    try{const t=getCpToken(); if(t) cp.value=t;}catch(_){}
    document.getElementById('btn-save-cp')?.addEventListener('click',()=>{saveCpToken(cp.value||''); alert('Token gespeichert (nur lokal).');});
    document.getElementById('btn-live-news')?.addEventListener('click',()=>{ if(getCpToken()) fetchCryptoPanic().then(b=>renderNewsBlock(b,'live')).catch(e=>alert('Fehler: '+e.message)); else alert('Bitte zuerst Token speichern.'); });

    function setAdminFromURL(){
      const qs=new URLSearchParams(location.search);
      if(qs.has('setup') || qs.get('admin')==='1'){localStorage.setItem('cryptoDash.admin','1');}
      if(qs.has('noadmin')){localStorage.removeItem('cryptoDash.admin');}
    }
    function isAdmin(){return localStorage.getItem('cryptoDash.admin')==='1';}
    function bindTabs(){
      document.querySelectorAll('.tabs').forEach(group=>{
        group.addEventListener('click',(e)=>{
          const btn=e.target.closest('.tab'); if(!btn) return;
          const asset=group.getAttribute('data-asset'); const tf=btn.getAttribute('data-tf');
          TF_STATE[asset]=tf;
          group.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b===btn));
          if(LAST){
            const color=asset==='btc'?getComputedStyle(document.documentElement).getPropertyValue('--btc').trim():getComputedStyle(document.documentElement).getPropertyValue('--kas').trim();
            drawSpark(asset+'-chart', series(asset, tf), color);
          }
        });
      });
    }

    (function init(){
      bindTabs();
      setAdminFromURL();
      if(isAdmin()){
        document.getElementById('btn-settings').style.display='inline-flex';
        if(location.hash==='#settings' || new URLSearchParams(location.search).has('setup')){
          settings.classList.remove('hidden');
        }
      }
      const saved=localStorage.getItem('cryptoDash.endpoint');
      if(saved){ ep.value=saved; doFetch(saved); } else {
        const d = JSON.parse(JSON.stringify(DEMO));
        d._fetched_at = new Date().toISOString();
        render(d);
      }
    })();

    document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ const s=localStorage.getItem('cryptoDash.endpoint'); if(s) doFetch(s); }});
    window.addEventListener('online',()=>{ const s=localStorage.getItem('cryptoDash.endpoint'); if(s) doFetch(s); });

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  </script>
</body>
</html>
